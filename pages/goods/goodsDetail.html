<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<link rel="stylesheet" type="text/css" href="../../dist/css/layui.css" />
		<link rel="stylesheet" href="../../css/goods/sku_style.css" />
		<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
		<script src="https://cdn.bootcss.com/vue/2.6.10/vue.min.js"></script>
		<script src="../../dist/layui.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://unpkg.com/http-vue-loader"></script>
		<script src="../../js/environment.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/kboot.js" type="text/javascript" charset="utf-8"></script>
		<style type="text/css">
			#sku {
				border: #000077 2px dashed;
				padding: 10px;
			}

			#app {
				padding: 20px;
			}

			#introVideo {
				cursor: pointer;
			}

			.video-mask {
				width: 1000px;
				height: 600px;
				position: absolute;
				display: flex;
				align-items: center;
				justify-content: center;
				color: yellow;
				z-index: 10;
			}

			.block-container {
				display: flex;
			}

			.redStar {
				color: red;
				font-size: 1.5rem;
			}
		</style>
	</head>
	<body>
		<div id="app">
			<form class="layui-form" id="myform">
				<div class="layui-form-item">
					<label class="layui-form-label">商品标题<span class="redStar">*</span></label>
					<div class="layui-input-block">
						<input type="text" name="title" disabled v-model="title" required lay-verify="required" placeholder="请输入标题"
						 autocomplete="off" class="layui-input">
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">默认价格<span class="redStar">*</span></label>
					<div class="layui-input-inline">
						<input type="text" disabled name="defaultPrice" v-model="defaultPrice" required lay-verify="required" placeholder="请输入默认价格(元)"
						 autocomplete="off" class="layui-input input-price">
					</div>
					<label class="layui-form-label">运费价格</label>
					<div class="layui-input-inline">
						<input type="text" id="postage" name="postage" v-model="postage" required lay-verify="required" placeholder="请输入运费价格(元)"
						 autocomplete="off" class="layui-input input-price">
					</div>
					<div class="layui-input-inline">
						<button type="button" class="layui-btn layui-btn-normal" @click="modifyPostage">修改</button>
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">详情标签</label>
					<div class="layui-input-block">
						<!--详情标签-->
						<input v-for="(item,index) in labelList" disabled type="text" maxlength="5" style="width: 150px;margin-right: 10px;"
						 :placeholder="item.placeholder" v-model="item.value" autocomplete="off" class="layui-input layui-col-md1">
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">封面图片<span class="redStar">*</span></label>
					<div class="layui-input-block">
						<img-area :imgs="cover"></img-area>
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">商品分类<span class="redStar">*</span></label>
					<label class="layui-form-label">{{goodsClassify}}</label>
				</div>
			</form>

			<!--轮播图显示静态资源-->
			<div class="layui-form-item">
				<label class="layui-form-label">轮播图片<span class="redStar">*</span></label>
				<div class="layui-input-block">
					<img-area :imgs="swiper"></img-area>
				</div>
			</div>
			<!--轮播图视频-->
			<div class="layui-form-item">
				<label class="layui-form-label">视频上传</label>
				<div class="layui-input-block block-container">
					<div v-show="!hasVideo" class="video-mask"><button class="layui-btn layui-btn-primary" @click="uploadVideo">上传视频</button></div>
					<video width="1000px" autoplay height="600px" :src="myVideo" controls="controls" id="introVideo"></video>
					<button class="layui-btn layui-btn-danger" @click="delVideo" v-show="hasVideo" type="button">删除视频</button>
				</div>
			</div>

			<!--商品详情图-->
			<div class="layui-form-item">
				<label class="layui-form-label">详情图片<span class="redStar">*</span></label>
				<div class="layui-input-block">
					<img-area :imgs="detailPhotos"></img-area>
				</div>
			</div>

			<!--商品规格管理-->
			<div class="layui-form-item">
				<label class="layui-form-label">规格库存<span class="redStar">*</span></label>
				<table class="layui-table">
					<tr>
						<th>规格</th>
						<th>价格(元)</th>
						<th>库存(件)</th>
					</tr>
					<tr v-for="(item,index) in specs">
						<td>{{item.specClass}}</td>
						<td>
							<input class="specPrice" type="text" name="" id="" :value="item.specPrice" />
							<button class="layui-btn layui-btn-normal" @click="modifyPrice(item,index)">修改</button>
						</td>
						<td>
							<input class="specInventory" type="number" name="" id="" :value="item.specInventory" />
							<button class="layui-btn layui-btn-normal" @click="modifyInventory(item,index)">修改</button>
						</td>
					</tr>
				</table>
			</div>
		</div>
	</body>

	<script type="text/javascript">
		var example = {
			layEditNum:0,
			gid: "",
			title: "",
			defaultPrice: "",
			postage: "",
			goodsClassify: "",
			myVideo: "", //uri
			hasVideo: false,
			second: [],
			categoryIndex: [null, null],
			category: [],
			specs: [],
			labelList: [{
				placeholder: "标签1",
				value: ""
			}, {
				placeholder: "标签2",
				value: ""
			}, {
				placeholder: "标签3",
				value: ""
			}, {
				placeholder: "标签4",
				value: ""
			}, {
				placeholder: "标签5",
				value: ""
			}],
			cover: [],
			swiper: [],
			detailPhotos: []
		}

		function getDetailLabel() {
			var detailLabel = ""
			var list = example.labelList
			for (let i = 0; i < list.length; i++) {
				if (list[i].value) {
					detailLabel = detailLabel + list[i].value + ","
				}
			}
			return detailLabel
		}

		function getSlideShow() {
			var slideShow = ""
			var list = example.swiper
			for (let i = 0; i < list.length; i++) {
				if (list[i].url) {
					slideShow = slideShow + list[i].url + ","
				}
			}
			if (example.myVideo) {
				slideShow += example.myVideo
			}
			return slideShow
		}

		function getDetaiPhotos() {
			var detailPhotos = ""
			var list = example.detailPhotos
			for (let i = 0; i < list.length; i++) {
				if (list[i].url) {
					detailPhotos = detailPhotos + list[i].url + ","
				}
			}
			return detailPhotos
		}

		function createFirst() {
			var select1 = document.getElementById("classify1");
			for (let i in example.category) {
				select1.add(new Option(example.category[i].name, i))
			}
			var form = layui.form
			form.render()
		}

		function addSecond() {
			var select2 = document.getElementById("classify2");
			var first = document.getElementById("classify1").value;
			select2.length = 1;
			var second = example.category[first].second
			for (let i in second) {
				select2.add(new Option(second[i].name, i))
			}
		}

		function isVideo(url) {
			if (!url)
				return false
			var strs = url.split('.')
			if (!strs)
				return false
			let str = strs[strs.length - 1]
			if (str == "mp4" || str == "mkv" || str == "flv")
				return true
			else
				return false
		}

		function clearSecond() {
			var select2 = document.getElementById("classify2");
			select2.length = 1
		}

		function checkRequired() {
			if (!example.title) {
				layer.msg("必须输入商品标题")
				return false
			}
			if (!example.categoryIndex[0] || !example.categoryIndex[1]) {
				layer.msg("商品分类没选完")
				return false
			}
			if (!example.defaultPrice) {
				layer.msg("必须输入商品默认价格")
				return false
			}
			if (!example.cover[0].url) {
				layer.msg("商品封面必须要加")
				return false
			}
			if (!getSlideShow()) {
				layer.msg("轮播图至少要有一张")
				return false
			}
			if (!getDetaiPhotos()) {
				layer.msg("详情图至少要有一张")
				return false
			}
			return true
		}

		/**
		 * jQuery 
		 *
		 */
		$(function() {
			$(".input-price").keyup(function() {
				var reg = $(this).val().match(/\d+\.?\d{0,2}/);
				var txt = '';
				if (reg != null) {
					txt = reg[0];
				}
				$(this).val(txt);
			}).change(function() {
				$(this).keypress();
				var v = $(this).val();
				if (/\.$/.test(v)) {
					$(this).val(v.substr(0, v.length - 1));
				}
			});
		})
	</script>
	<script src="../../js/util/provinces.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		var vm = new Vue({
			el: "#app",
			components: {
				'img-area': httpVueLoader('/jiwuzao-merchant/plugins/imgArea.vue'),
			},
			data() {
				return example;
			},
			beforeCreate() {
				var goodsDetail = storageGet('goodsDetail')
				console.log('````````````````', goodsDetail)
				if (goodsDetail) {
					example.gid = goodsDetail.gid
					example.title = goodsDetail.title
					example.specs = goodsDetail.goodsSpecs
					example.defaultPrice = goodsDetail.defaultPrice
					var cover = {
						url: goodsDetail.cover,
						msg: "封面",
						showDelete: false,
						style: {
							"width": "200px",
							"height": "200px",
						}
					}
					example.cover.push(cover)
					example.postage = goodsDetail.postage
					example.goodsClassify = goodsDetail.classify
					goodsDetail.detailLabel.split(',').forEach((item, index) => {
						if (item)
							example.labelList[index].value = item
					})
					goodsDetail.slideShow.split(',').forEach((item, index) => {
						if (item) {
							if (isVideo(item)) {
								example.myVideo = item
								example.hasVideo = true
							} else {
								var swiperItem = {
									url: item,
									msg: "",
									showDelete: false,
									style: {
										width: "300px",
										height: "200px"
									}
								}
								example.swiper.push(swiperItem)
							}
						}
					})
					goodsDetail.detailPhotos.split(',').forEach((item, index) => {
						if (item) {
							var photoItem = {
								url: item,
								msg: "",
								showDelete: false,
								style: {
									"width": "300px",
									"height": "500px",
								}
							}
							example.detailPhotos.push(photoItem)
						}
					})
				}
			},
			beforeMount() {},
			created() {},
			mounted() {
				//初始创建一级类目的下拉菜单
				var request = post(false, major + "/goods/getCategory", {
					"categoryId": 1
				})
				handleRequest(request, function(res) {
					example.category = JSON.parse(res.data.category)
					createFirst()
				})
			},
			methods: {
				uploadVideo(e) {
					if (!this.myVideo) {
						uploadVideo(function(res) {
							example.myVideo = res
							example.hasVideo = true
						})
					}
				},
				delVideo() {
					delVideo(example.myVideo, function(res) {})
					example.myVideo = ""
					example.hasVideo = false
				},
				modifyPrice(item, index) {
					var specPrice = $(".specPrice")[index].value
					if (!isMoney(specPrice)) {
						layer.msg('请输入正确的价格')
						return false
					}
					var request = post(true, major + "/goods/modifyPrice", {
						gid: example.gid,
						goodsSpecId: item.id,
						goodsPrice: specPrice
					})
					handleRequest(request, function(res) {
						if (res.state == "success") {
							layer.msg("修改成功！")
						}
					})
				},
				modifyInventory(item, index) {
					console.log(item + "," + index)
					var specInventory = $(".specInventory")[index].value
					if (specInventory < 0) {
						layer.msg('请输入正确的库存数量')
						return false
					}
					var request = post(true, major + "/goods/modifyInventory", {
						gid: example.gid,
						goodsSpecId: item.id,
						inventory: specInventory
					})
					handleRequest(request, function(res) {
						if (res.state == "success") {
							layer.msg("修改成功！")
						}
					})
				},
				modifyPostage() {
					var postage = $("#postage").val()
					if (!isMoney(postage)) {
						layer.msg('请输入正确的价格')
						return false
					}
					var request = post(true, major + "/goods/modifyPostage", {
						gid: example.gid,
						postage: postage
					})
					handleRequest(request, function(res) {
						if (res.state == "success") {
							layer.msg("修改成功！")
						}
					})
				}
			},
		})
	</script>

	<script type="text/javascript">
		layui.use(['layer', 'jquery', 'form'], function() {
			var form = layui.form;
			form.on('select(first)', function(data) {
				console.log('layui', data)
				if (data.value) {
					example.categoryIndex[0] = data.value
					example.second = example.category[data.value].second
					addSecond()
				} else {
					clearSecond();
				}
				form.render('select');
			});
			form.on('select(second)', function(data) {
				console.log('second', data)
				if (data.value) {
					example.categoryIndex[1] = data.value
				}
				form.render('select');
			});
		});
	</script>


</html>
